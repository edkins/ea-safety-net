<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="/static/style.css">
<script>
'use strict';
function get_privs(fn)
{
	var xhr = new XMLHttpRequest();
	xhr.addEventListener('load', function() {
		if (xhr.status === 200)
		{
			var obj = JSON.parse(xhr.response);
			fn(obj.privileges);
		}
		else
		{
			fn({});
		}
	});
	xhr.open('GET', '/userpage/privs');
	xhr.send();
}

function get_profile(fn)
{
	var xhr = new XMLHttpRequest();
	xhr.addEventListener('load', function() {
		if (xhr.status === 200)
		{
			var obj = JSON.parse(xhr.response);
			fn(obj.profile);
		}
	});
	xhr.open('GET', '/userpage/profile');
	xhr.send();
}

function fetch_tabs()
{
	get_privs( function(privs) {
		if ('user' in privs)
		{
			document.getElementById('user-tab').className = ('user' in privs) ? 'tab' : 'hidden';
			document.getElementById('admin-tab').className = ('admin' in privs) ? 'tab' : 'hidden';
			document.getElementById('psn-tab').className = ('psn' in privs) ? 'tab' : 'hidden';
			show_user_page()
		}
		else
		{
			logout();
		}
	} );
}

function logout()
{
	var xhr = new XMLHttpRequest();
	xhr.addEventListener('load', function() {
		window.location.replace('/index.html')
	});
	xhr.open('POST', '/userpage/logout');
	xhr.send();
}

function deactivate_tab(tab)
{
	if (tab.className === 'activetab')
	{
		tab.className = 'tab';
	}
}

function activate_tab(tab)
{
	if (tab.className === 'tab')
	{
		tab.className = 'activetab';
	}
}

function hide_pages()
{
	document.getElementById('user-page').className = 'hidden';
	document.getElementById('admin-page').className = 'hidden';
	document.getElementById('psn-page').className = 'hidden';
	deactivate_tab(document.getElementById('user-tab'));
	deactivate_tab(document.getElementById('admin-tab'));
	deactivate_tab(document.getElementById('psn-tab'));
}

function show_user_page()
{
	get_profile( function(profile) {
		hide_pages();
		document.getElementById('user-page').className = 'page';
		activate_tab(document.getElementById('user-tab'));
		document.getElementById('greeting-name').textContent = profile.name;
	});
}

function show_admin_page()
{
	hide_pages();
	document.getElementById('admin-page').className = 'page';
	activate_tab(document.getElementById('admin-tab'));
	show_admin_page_user();
}

function show_psn_page()
{
	hide_pages();
	document.getElementById('psn-page').className = 'page';
	activate_tab(document.getElementById('psn-tab'));
}

function hide_admin_pages()
{
	document.getElementById('user-admin').className = 'hidden';
	document.getElementById('psn-admin').className = 'hidden';
	deactivate_tab(document.getElementById('user-admin-tab'));
	deactivate_tab(document.getElementById('psn-admin-tab'));
}

function show_admin_page_user()
{
	hide_admin_pages();
	document.getElementById('user-admin').className = 'subpage';
	activate_tab(document.getElementById('user-admin-tab'));
}

function show_admin_page_psn()
{
	hide_admin_pages();
	document.getElementById('psn-admin').className = 'subpage';
	activate_tab(document.getElementById('psn-admin-tab'));
}
</script>
</head>
<body onload="fetch_tabs()">
<div class="header">
	<span class="hidden" id="user-tab" onclick="show_user_page()">User</span>
	<span class="hidden" id="admin-tab" onclick="show_admin_page()">Admin</span>
	<span class="hidden" id="psn-tab" onclick="show_psn_page()">PSN</span>
	<span class="spacer"></span>
	<span class="button" onclick="logout()">Logout</span>
</div>
<div class="hidden" id="user-page">
	Welcome, <span id="greeting-name"></span>!
</div>
<div class="hidden" id="admin-page">
	<div class="adminbar">
		<span class="tab" id="user-admin-tab" onclick="show_admin_page_user()">Users</span>
		<span class="tab" id="psn-admin-tab" onclick="show_admin_page_psn()">PSNs</span>
	</div>
	<div class="hidden" id="user-admin">
		List of users
	</div>
	<div class="hidden" id="psn-admin">
		List of PSNs
	</div>
</div>
<div class="hidden" id="psn-page">
	PSN stuff
</div>
</body>
</html>

